{% extends "layouts/base.html" %}

{% block title %}Marketplace - Rifas{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header e Filtros -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">
            Marketplace de Rifas
        </h1>

        <!-- Barra de Busca e Filtros -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
            <form hx-get="/marketplace/api/rifas" hx-target="#rifas-grid" hx-swap="innerHTML"
                  class="grid grid-cols-1 md:grid-cols-4 gap-4">

                <!-- Busca -->
                <div class="md:col-span-2">
                    <input type="text" name="search"
                           placeholder="Buscar rifas..."
                           class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg
                                  dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-purple-500"
                           hx-trigger="keyup changed delay:500ms">
                </div>

                <!-- Categoria -->
                <div>
                    <select name="category_id"
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg
                                   dark:bg-gray-700 dark:text-white"
                            hx-trigger="change">
                        <option value="">Todas Categorias</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.icon }} {{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Ordena√ß√£o -->
                <div>
                    <select name="sort_by"
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg
                                   dark:bg-gray-700 dark:text-white"
                            hx-trigger="change">
                        <option value="created_at">Mais Recentes</option>
                        <option value="end_date">Terminando Logo</option>
                        <option value="sold_count">Mais Vendidas</option>
                        <option value="price">Menor Pre√ßo</option>
                    </select>
                </div>
            </form>

            <!-- Filtros Avan√ßados (Toggle) -->
            <div x-data="{ open: false }" class="mt-4">
                <button @click="open = !open"
                        class="text-sm text-purple-600 dark:text-purple-400 hover:underline">
                    <span x-show="!open">+ Filtros Avan√ßados</span>
                    <span x-show="open">- Ocultar Filtros</span>
                </button>

                <div x-show="open" x-collapse class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Faixa de Pre√ßo -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Faixa de Pre√ßo
                        </label>
                        <div class="flex gap-2">
                            <input type="number" name="min_price" placeholder="Min"
                                   class="w-1/2 px-3 py-2 border rounded-lg dark:bg-gray-700 dark:text-white">
                            <input type="number" name="max_price" placeholder="Max"
                                   class="w-1/2 px-3 py-2 border rounded-lg dark:bg-gray-700 dark:text-white">
                        </div>
                    </div>

                    <!-- Apenas Destaque -->
                    <div class="flex items-center">
                        <input type="checkbox" name="is_featured" value="true"
                               class="w-4 h-4 text-purple-600 rounded">
                        <label class="ml-2 text-sm text-gray-700 dark:text-gray-300">
                            Apenas em Destaque
                        </label>
                    </div>

                    <!-- Apenas Verificadas -->
                    <div class="flex items-center">
                        <input type="checkbox" name="is_verified" value="true"
                               class="w-4 h-4 text-purple-600 rounded">
                        <label class="ml-2 text-sm text-gray-700 dark:text-gray-300">
                            Apenas Verificadas
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rifas em Destaque -->
    <div class="mb-12">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">
            üåü Em Destaque
        </h2>
        <div id="featured-rifas"
             hx-get="/marketplace/api/rifas/featured"
             hx-trigger="load"
             class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Carregando... -->
            <div class="col-span-full text-center py-8">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500 mx-auto"></div>
            </div>
        </div>
    </div>

    <!-- Grid de Rifas -->
    <div>
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">
            Todas as Rifas
        </h2>
        <div id="rifas-grid"
             hx-get="/marketplace/api/rifas"
             hx-trigger="load"
             class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Carregando... -->
            <div class="col-span-full text-center py-8">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500 mx-auto"></div>
            </div>
        </div>

        <!-- Pagina√ß√£o -->
        <div id="pagination" class="mt-8"></div>
    </div>
</div>

<!-- Template para Card de Rifa (usado via HTMX) -->
<template id="rifa-card-template">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden hover:shadow-xl transition-shadow">
        <!-- Imagem -->
        <div class="relative h-48 bg-gray-200 dark:bg-gray-700">
            <img data-rifa-image class="w-full h-full object-cover" alt="">
            <div class="absolute top-2 right-2 flex gap-2">
                <span data-rifa-featured class="hidden bg-yellow-500 text-white text-xs px-2 py-1 rounded-full">
                    ‚≠ê Destaque
                </span>
                <span data-rifa-verified class="hidden bg-blue-500 text-white text-xs px-2 py-1 rounded-full">
                    ‚úì Verificado
                </span>
            </div>
            <!-- Barra de Progresso -->
            <div class="absolute bottom-0 left-0 right-0 h-2 bg-gray-300 dark:bg-gray-600">
                <div data-rifa-progress class="h-full bg-purple-500 transition-all"></div>
            </div>
        </div>

        <!-- Conte√∫do -->
        <div class="p-4">
            <h3 data-rifa-title class="text-lg font-bold text-gray-900 dark:text-white mb-2 truncate"></h3>

            <div class="flex items-center justify-between mb-3">
                <span data-rifa-price class="text-2xl font-bold text-purple-600 dark:text-purple-400"></span>
                <span data-rifa-numbers class="text-sm text-gray-600 dark:text-gray-400"></span>
            </div>

            <div class="flex items-center gap-2 mb-3 text-sm text-gray-600 dark:text-gray-400">
                <span data-rifa-category></span>
                <span>‚Ä¢</span>
                <span data-rifa-creator></span>
            </div>

            <div class="text-xs text-gray-500 dark:text-gray-400 mb-3">
                Termina em: <span data-rifa-end-date></span>
            </div>

            <a data-rifa-link href="#"
               class="block w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4
                      rounded-lg text-center transition-colors">
                Ver Rifa
            </a>
        </div>
    </div>
</template>
{% endblock %}

{% block scripts %}
<script>
// Fun√ß√£o para renderizar cards de rifas
function renderRifaCard(rifa) {
    const template = document.getElementById('rifa-card-template');
    const card = template.content.cloneNode(true);

    // Preencher dados
    card.querySelector('[data-rifa-image]').src = rifa.image_url || '/static/images/placeholder.jpg';
    card.querySelector('[data-rifa-title]').textContent = rifa.title;
    card.querySelector('[data-rifa-price]').textContent = `R$ ${rifa.price.toFixed(2)}`;
    card.querySelector('[data-rifa-numbers]').textContent = `${rifa.sold_count}/${rifa.total_numbers} vendidos`;
    card.querySelector('[data-rifa-progress]').style.width = `${rifa.progress_percent}%`;
    card.querySelector('[data-rifa-category]').textContent = rifa.category_name || 'Sem categoria';
    card.querySelector('[data-rifa-creator]').textContent = `@${rifa.creator_username}`;
    card.querySelector('[data-rifa-end-date]').textContent = new Date(rifa.end_date).toLocaleDateString('pt-BR');
    card.querySelector('[data-rifa-link]').href = `/marketplace/rifas/${rifa.slug}`;

    // Badges
    if (rifa.is_featured) {
        card.querySelector('[data-rifa-featured]').classList.remove('hidden');
    }
    if (rifa.is_verified) {
        card.querySelector('[data-rifa-verified]').classList.remove('hidden');
    }

    return card;
}

// Interceptar resposta HTMX e renderizar cards
document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.target.id === 'rifas-grid' || evt.detail.target.id === 'featured-rifas') {
        const data = JSON.parse(evt.detail.xhr.response);
        const rifas = data.items || data;
        const container = evt.detail.target;
        container.innerHTML = '';

        if (rifas.length === 0) {
            container.innerHTML = '<p class="col-span-full text-center text-gray-500 py-8">Nenhuma rifa encontrada</p>';
            return;
        }

        rifas.forEach(rifa => {
            container.appendChild(renderRifaCard(rifa));
        });

        // Renderizar pagina√ß√£o se houver
        if (data.total_pages > 1) {
            renderPagination(data);
        }
    }
});

// Renderizar pagina√ß√£o
function renderPagination(data) {
    const container = document.getElementById('pagination');
    let html = '<div class="flex justify-center gap-2">';

    // Bot√£o anterior
    if (data.has_prev) {
        html += `<button hx-get="/marketplace/api/rifas?page=${data.page - 1}"
                         hx-target="#rifas-grid"
                         class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300">
                    Anterior
                 </button>`;
    }

    // P√°ginas
    for (let i = Math.max(1, data.page - 2); i <= Math.min(data.total_pages, data.page + 2); i++) {
        const isActive = i === data.page;
        html += `<button hx-get="/marketplace/api/rifas?page=${i}"
                         hx-target="#rifas-grid"
                         class="px-4 py-2 rounded-lg ${isActive ? 'bg-purple-600 text-white' : 'bg-gray-200 dark:bg-gray-700 hover:bg-gray-300'}">
                    ${i}
                 </button>`;
    }

    // Bot√£o pr√≥ximo
    if (data.has_next) {
        html += `<button hx-get="/marketplace/api/rifas?page=${data.page + 1}"
                         hx-target="#rifas-grid"
                         class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300">
                    Pr√≥ximo
                 </button>`;
    }

    html += '</div>';
    container.innerHTML = html;
}
</script>
{% endblock %}
