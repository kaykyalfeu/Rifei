{% extends "layouts/base.html" %}

{% block title %}{{ rifa.title }}{% endblock %}

{% block content %}
<!-- Header -->
{% include "components/header.html" %}

<!-- Main Layout with Sidebar -->
<div class="pt-16 lg:pl-64 min-h-screen">
    {% include "components/sidebar.html" %}

    <!-- Main Content -->
    <main class="p-4 md:p-8">
        <!-- Breadcrumb -->
        <nav class="mb-6">
            <ol class="flex items-center gap-2 text-sm text-gray-500">
                <li><a href="/" class="hover:text-emerald-600 transition-colors">Inicio</a></li>
                <li><i data-lucide="chevron-right" class="w-4 h-4"></i></li>
                <li><a href="/marketplace" class="hover:text-emerald-600 transition-colors">Marketplace</a></li>
                {% if rifa.category %}
                <li><i data-lucide="chevron-right" class="w-4 h-4"></i></li>
                <li><a href="/categoria/{{ rifa.category.slug }}" class="hover:text-emerald-600 transition-colors">{{ rifa.category.name }}</a></li>
                {% endif %}
                <li><i data-lucide="chevron-right" class="w-4 h-4"></i></li>
                <li class="text-gray-900 dark:text-white font-medium">{{ rifa.title | truncate(30) }}</li>
            </ol>
        </nav>

        <div class="grid lg:grid-cols-2 gap-8">
            <!-- Left Column - Image and Info -->
            <div>
                <!-- Main Image -->
                <div class="glass rounded-3xl overflow-hidden border border-gray-200/50 dark:border-gray-700/50 mb-6">
                    <div class="aspect-square bg-gradient-to-br from-emerald-400/20 to-violet-400/20 flex items-center justify-center relative">
                        {% if rifa.image_url %}
                        <img src="{{ rifa.image_url }}" alt="{{ rifa.title }}" class="w-full h-full object-cover">
                        {% else %}
                        <span class="text-9xl">üéÅ</span>
                        {% endif %}

                        {% if rifa.is_featured %}
                        <span class="absolute top-4 left-4 px-4 py-2 rounded-full bg-gradient-to-r from-yellow-400 to-orange-500 text-white font-bold flex items-center gap-2">
                            <i data-lucide="flame" class="w-4 h-4"></i>
                            Em Destaque
                        </span>
                        {% endif %}

                        {% if rifa.is_verified %}
                        <span class="absolute top-4 right-4 px-3 py-2 rounded-full bg-blue-500 text-white font-bold flex items-center gap-1">
                            <i data-lucide="badge-check" class="w-4 h-4"></i>
                            Verificada
                        </span>
                        {% endif %}
                    </div>
                </div>

                <!-- Creator Info -->
                <div class="glass rounded-2xl p-6 border border-gray-200/50 dark:border-gray-700/50 mb-6">
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Organizador</h3>
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 rounded-2xl gradient-primary flex items-center justify-center text-white text-2xl font-bold shadow-lg shadow-emerald-500/25">
                            {% if rifa.creator %}{{ rifa.creator.name[0] | upper }}{% else %}R{% endif %}
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <h4 class="font-bold text-lg">
                                    {% if rifa.creator %}{{ rifa.creator.name }}{% else %}Rifei{% endif %}
                                </h4>
                                {% if rifa.creator and rifa.creator.is_verified %}
                                <i data-lucide="badge-check" class="w-5 h-5 text-blue-500"></i>
                                {% endif %}
                            </div>
                            {% if rifa.creator %}
                            <p class="text-gray-500 text-sm">@{{ rifa.creator.username }}</p>
                            {% endif %}
                        </div>
                        {% if rifa.creator %}
                        <a href="/perfil/{{ rifa.creator.username }}" class="px-4 py-2 rounded-xl border border-gray-200 dark:border-gray-700 font-medium hover:border-emerald-500 transition-colors">
                            Ver perfil
                        </a>
                        {% endif %}
                    </div>
                </div>

                <!-- Description -->
                <div class="glass rounded-2xl p-6 border border-gray-200/50 dark:border-gray-700/50">
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Descricao</h3>
                    <div class="prose prose-emerald dark:prose-invert max-w-none">
                        <p class="text-gray-600 dark:text-gray-300 whitespace-pre-line">{{ rifa.description or 'Sem descricao disponivel.' }}</p>
                    </div>
                </div>
            </div>

            <!-- Right Column - Purchase Section -->
            <div>
                <!-- Title and Price -->
                <div class="glass rounded-3xl p-6 border border-gray-200/50 dark:border-gray-700/50 mb-6">
                    {% if rifa.category %}
                    <div class="mb-4">
                        <span class="inline-flex items-center gap-1 px-3 py-1.5 rounded-lg bg-emerald-500/10 text-emerald-600 text-sm font-medium">
                            {{ rifa.category.icon if rifa.category.icon else 'üì¶' }} {{ rifa.category.name }}
                        </span>
                    </div>
                    {% endif %}

                    <h1 class="text-2xl md:text-3xl font-black mb-4">{{ rifa.title }}</h1>

                    <!-- Progress -->
                    <div class="mb-6">
                        <div class="flex justify-between text-sm mb-2">
                            <span class="text-gray-500">
                                <span class="font-bold text-gray-900 dark:text-white">{{ rifa.sold_count }}</span>
                                de {{ rifa.total_numbers }} numeros vendidos
                            </span>
                            <span class="font-bold text-emerald-600">{{ rifa.progress_percent | round(1) }}%</span>
                        </div>
                        <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                            <div class="h-full gradient-primary rounded-full transition-all" style="width: {{ rifa.progress_percent }}%"></div>
                        </div>
                    </div>

                    <!-- Stats Grid -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-gray-50 dark:bg-gray-800/50 rounded-xl p-4 text-center">
                            <p class="text-2xl font-black text-emerald-600">R$ {{ "%.2f" | format(rifa.price) }}</p>
                            <p class="text-sm text-gray-500">por numero</p>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-800/50 rounded-xl p-4 text-center">
                            <p class="text-2xl font-black text-violet-600">{{ rifa.available_count }}</p>
                            <p class="text-sm text-gray-500">disponiveis</p>
                        </div>
                    </div>

                    {% if rifa.end_date %}
                    <!-- Time Remaining -->
                    <div class="bg-orange-50 dark:bg-orange-900/20 rounded-xl p-4 mb-6 flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-orange-500 flex items-center justify-center">
                            <i data-lucide="clock" class="w-5 h-5 text-white"></i>
                        </div>
                        <div>
                            <p class="text-sm text-orange-600 dark:text-orange-400 font-medium">Encerra em</p>
                            <p class="font-bold">{{ rifa.end_date.strftime('%d/%m/%Y as %H:%M') }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Number Selection -->
                <div class="glass rounded-3xl p-6 border border-gray-200/50 dark:border-gray-700/50 mb-6"
                     x-data="{
                         selectedNumbers: [],
                         maxNumbers: {{ rifa.max_numbers_per_user or 10 }},
                         price: {{ rifa.price }},
                         availableNumbers: {{ available_numbers | tojson }},
                         toggleNumber(num) {
                             const idx = this.selectedNumbers.indexOf(num);
                             if (idx > -1) {
                                 this.selectedNumbers.splice(idx, 1);
                             } else if (this.selectedNumbers.length < this.maxNumbers) {
                                 this.selectedNumbers.push(num);
                             }
                         },
                         isSelected(num) {
                             return this.selectedNumbers.includes(num);
                         },
                         isAvailable(num) {
                             return this.availableNumbers.includes(num);
                         },
                         get total() {
                             return (this.selectedNumbers.length * this.price).toFixed(2);
                         }
                     }">
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Escolha seus numeros</h3>

                    <p class="text-sm text-gray-500 mb-4">
                        Selecione ate <span class="font-bold">{{ rifa.max_numbers_per_user or 10 }}</span> numeros.
                        <span class="text-emerald-600 font-medium" x-text="`${selectedNumbers.length} selecionado(s)`"></span>
                    </p>

                    <!-- Numbers Grid -->
                    <div class="max-h-64 overflow-y-auto mb-6 pr-2">
                        <div class="grid grid-cols-5 sm:grid-cols-8 md:grid-cols-10 gap-2">
                            {% for num in range(1, rifa.total_numbers + 1) %}
                            <button
                                type="button"
                                @click="isAvailable({{ num }}) && toggleNumber({{ num }})"
                                :class="{
                                    'gradient-primary text-white shadow-lg shadow-emerald-500/25': isSelected({{ num }}),
                                    'bg-gray-100 dark:bg-gray-800 hover:border-emerald-500': isAvailable({{ num }}) && !isSelected({{ num }}),
                                    'bg-gray-200 dark:bg-gray-700 text-gray-400 cursor-not-allowed line-through': !isAvailable({{ num }})
                                }"
                                class="w-full aspect-square rounded-xl flex items-center justify-center font-bold text-sm border border-transparent transition-all"
                                :disabled="!isAvailable({{ num }})"
                            >
                                {{ num }}
                            </button>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="flex flex-wrap gap-4 mb-6 text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 rounded gradient-primary"></div>
                            <span>Selecionado</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 rounded bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700"></div>
                            <span>Disponivel</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 rounded bg-gray-200 dark:bg-gray-700"></div>
                            <span>Vendido</span>
                        </div>
                    </div>

                    <!-- Total and Buy Button -->
                    <div class="border-t border-gray-200/50 dark:border-gray-700/50 pt-6">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-gray-500">Total</span>
                            <span class="text-3xl font-black text-emerald-600">R$ <span x-text="total">0.00</span></span>
                        </div>

                        {% if user %}
                        <button
                            type="button"
                            :disabled="selectedNumbers.length === 0"
                            @click="window.location.href = `/checkout?rifa={{ rifa.id }}&numbers=${selectedNumbers.join(',')}`"
                            :class="selectedNumbers.length === 0 ? 'opacity-50 cursor-not-allowed' : 'hover:scale-105 hover:shadow-emerald-500/50'"
                            class="w-full py-4 rounded-2xl gradient-primary text-white font-bold text-lg shadow-xl shadow-emerald-500/30 transition-all flex items-center justify-center gap-2"
                        >
                            <i data-lucide="credit-card" class="w-5 h-5"></i>
                            <span x-text="selectedNumbers.length === 0 ? 'Selecione seus numeros' : `Comprar ${selectedNumbers.length} numero(s)`">Selecione seus numeros</span>
                        </button>
                        {% else %}
                        <a
                            href="/login?next=/rifa/{{ rifa.slug }}"
                            class="w-full py-4 rounded-2xl gradient-primary text-white font-bold text-lg shadow-xl shadow-emerald-500/30 hover:scale-105 hover:shadow-emerald-500/50 transition-all flex items-center justify-center gap-2"
                        >
                            <i data-lucide="log-in" class="w-5 h-5"></i>
                            Entre para participar
                        </a>
                        {% endif %}
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="grid grid-cols-2 gap-4">
                    <button
                        onclick="navigator.share ? navigator.share({title: '{{ rifa.title }}', url: window.location.href}) : navigator.clipboard.writeText(window.location.href).then(() => showToast('Link copiado!', 'success'))"
                        class="glass rounded-xl p-4 border border-gray-200/50 dark:border-gray-700/50 flex items-center justify-center gap-2 font-medium hover:border-emerald-500 transition-colors"
                    >
                        <i data-lucide="share-2" class="w-5 h-5"></i>
                        Compartilhar
                    </button>
                    <button
                        class="glass rounded-xl p-4 border border-gray-200/50 dark:border-gray-700/50 flex items-center justify-center gap-2 font-medium hover:border-emerald-500 transition-colors"
                    >
                        <i data-lucide="heart" class="w-5 h-5"></i>
                        Favoritar
                    </button>
                </div>
            </div>
        </div>
    </main>
</div>
{% endblock %}
