# Makefile para Rifei - Comandos Ãºteis de desenvolvimento e teste

.PHONY: help install test test-unit test-integration test-cov test-fast lint format clean run db-migrate db-upgrade

# VariÃ¡veis
PYTHON := python3
PYTEST := pytest
PIP := pip3

help:
	@echo "Comandos disponÃ­veis:"
	@echo "  make install          - Instala dependÃªncias do projeto"
	@echo "  make test             - Executa todos os testes"
	@echo "  make test-unit        - Executa apenas testes unitÃ¡rios"
	@echo "  make test-integration - Executa apenas testes de integraÃ§Ã£o"
	@echo "  make test-cov         - Executa testes com coverage e abre relatÃ³rio"
	@echo "  make test-fast        - Executa testes rÃ¡pidos (sem slow tests)"
	@echo "  make lint             - Verifica cÃ³digo com ruff"
	@echo "  make format           - Formata cÃ³digo com black"
	@echo "  make clean            - Remove arquivos temporÃ¡rios"
	@echo "  make run              - Inicia servidor de desenvolvimento"
	@echo "  make db-migrate       - Cria nova migraÃ§Ã£o do banco"
	@echo "  make db-upgrade       - Aplica migraÃ§Ãµes pendentes"

install:
	@echo "ðŸ“¦ Instalando dependÃªncias..."
	$(PIP) install -r requirements.txt
	@echo "âœ… DependÃªncias instaladas!"

test:
	@echo "ðŸ§ª Executando todos os testes..."
	$(PYTEST)

test-unit:
	@echo "ðŸ§ª Executando testes unitÃ¡rios..."
	$(PYTEST) -m "unit"

test-integration:
	@echo "ðŸ§ª Executando testes de integraÃ§Ã£o..."
	$(PYTEST) -m "integration"

test-api:
	@echo "ðŸ§ª Executando testes de API..."
	$(PYTEST) -m "api"

test-auth:
	@echo "ðŸ§ª Executando testes de autenticaÃ§Ã£o..."
	$(PYTEST) -m "auth"

test-cov:
	@echo "ðŸ“Š Executando testes com coverage..."
	$(PYTEST) --cov=app --cov-report=html --cov-report=term-missing
	@echo "ðŸ“ˆ Abrindo relatÃ³rio de coverage..."
	@$(PYTHON) -m webbrowser htmlcov/index.html || open htmlcov/index.html || xdg-open htmlcov/index.html

test-fast:
	@echo "âš¡ Executando testes rÃ¡pidos..."
	$(PYTEST) -m "not slow"

test-watch:
	@echo "ðŸ‘€ Executando testes em modo watch..."
	$(PYTEST) -f

test-verbose:
	@echo "ðŸ” Executando testes em modo verbose..."
	$(PYTEST) -vv

test-failed:
	@echo "ðŸ” Re-executando testes que falharam..."
	$(PYTEST) --lf

lint:
	@echo "ðŸ” Verificando cÃ³digo com ruff..."
	ruff check app tests

format:
	@echo "âœ¨ Formatando cÃ³digo com black..."
	black app tests
	@echo "âœ… CÃ³digo formatado!"

clean:
	@echo "ðŸ§¹ Limpando arquivos temporÃ¡rios..."
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete
	find . -type f -name "*.pyo" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".ruff_cache" -exec rm -rf {} + 2>/dev/null || true
	rm -rf htmlcov/
	rm -rf .coverage
	rm -rf coverage.xml
	rm -rf dist/
	rm -rf build/
	@echo "âœ… Limpeza concluÃ­da!"

run:
	@echo "ðŸš€ Iniciando servidor de desenvolvimento..."
	uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

run-prod:
	@echo "ðŸš€ Iniciando servidor em modo produÃ§Ã£o..."
	uvicorn app.main:app --host 0.0.0.0 --port 8000

db-migrate:
	@echo "ðŸ“ Criando nova migraÃ§Ã£o..."
	@read -p "Nome da migraÃ§Ã£o: " name; \
	alembic revision --autogenerate -m "$$name"

db-upgrade:
	@echo "â¬†ï¸  Aplicando migraÃ§Ãµes..."
	alembic upgrade head

db-downgrade:
	@echo "â¬‡ï¸  Revertendo Ãºltima migraÃ§Ã£o..."
	alembic downgrade -1

db-reset:
	@echo "âš ï¸  Resetando banco de dados..."
	@read -p "Tem certeza? Todos os dados serÃ£o perdidos! [y/N]: " confirm; \
	if [ "$$confirm" = "y" ]; then \
		alembic downgrade base; \
		alembic upgrade head; \
		echo "âœ… Banco resetado!"; \
	else \
		echo "âŒ OperaÃ§Ã£o cancelada"; \
	fi

dev-setup:
	@echo "ðŸ› ï¸  Configurando ambiente de desenvolvimento..."
	@make install
	@echo "ðŸ“ Criando arquivo .env..."
	@if [ ! -f .env ]; then \
		cp .env.example .env 2>/dev/null || echo "Crie manualmente o arquivo .env"; \
	fi
	@echo "âœ… Setup completo! Execute 'make run' para iniciar o servidor"

# Atalhos
t: test
tc: test-cov
tf: test-fast
l: lint
f: format
r: run
c: clean
